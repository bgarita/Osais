/*
 * AnulacionRecibosCXP.java
 *
 * Created on 28/05/2012, 07:50:00 PM
 */

package interfase.transacciones;

import Mail.Bitacora;
import accesoDatos.CMD;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.JOptionPane;
import logica.Catransa;
import logica.utilitarios.Ut;

/**
 *
 * @author Bosco
 */
@SuppressWarnings("serial")
public class AnulacionRecibosCXP extends java.awt.Dialog {
    private final Connection conn;  // Conexión a la base de datos
    String recibo;                  // Aquí estará el recibo pasado por parámetro
    private ResultSet rs  = null;   // Uso general
    private int reccaja;            // Referencia de caja

    public AnulacionRecibosCXP(
            java.awt.Frame parent,
            boolean modal,
            Connection c, 
            String recnume) {
        
        super(parent, modal);
        initComponents();

        this.setAlwaysOnTop(false);

        conn   = c;
        recibo = recnume.trim();
        reccaja = 0;

        // Si el número de recibo recibido es un cero entonces habilito
        // el campo para que el usuario pueda digitar un número.
        txtRecnume.setEnabled(Integer.parseInt(recibo) == 0);

        txtRecnume.setText(recibo);

        // Si el campo está habilitado le pongo el focus...
        if (txtRecnume.isEnabled()) {
            txtRecnume.requestFocusInWindow();
        }else{ // ... caso contrario ejecuto el evento que busca el recibo
            txtRecnumeFocusLost(null);
            btnAnular.requestFocusInWindow();
        } // end if
    } // end constructor

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        btnAnular = new javax.swing.JButton();
        btnSalir = new javax.swing.JButton();
        txtRecnume = new javax.swing.JFormattedTextField();
        lblProdesc = new javax.swing.JLabel();
        jLabel2 = new javax.swing.JLabel();
        jLabel3 = new javax.swing.JLabel();
        txtFecha = new javax.swing.JTextField();
        txtMonto = new javax.swing.JTextField();
        lblMoneda = new javax.swing.JLabel();
        jLabel4 = new javax.swing.JLabel();

        setIconImage(null);
        setModalityType(java.awt.Dialog.ModalityType.DOCUMENT_MODAL);
        setTitle("Anular recibos (CXP)");
        addWindowListener(new java.awt.event.WindowAdapter() {
            public void windowClosing(java.awt.event.WindowEvent evt) {
                closeDialog(evt);
            }
        });

        btnAnular.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        btnAnular.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Icons/WZUNDO.png"))); // NOI18N
        btnAnular.setText("Anular");
        btnAnular.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                btnAnularMouseClicked(evt);
            }
        });
        btnAnular.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnAnularActionPerformed(evt);
            }
        });

        btnSalir.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        btnSalir.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Icons/control-power.png"))); // NOI18N
        btnSalir.setText("Cerrar");
        btnSalir.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnSalirActionPerformed(evt);
            }
        });

        txtRecnume.setFormatterFactory(new javax.swing.text.DefaultFormatterFactory(new javax.swing.text.NumberFormatter(new java.text.DecimalFormat("#0"))));
        txtRecnume.setHorizontalAlignment(javax.swing.JTextField.RIGHT);
        txtRecnume.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                txtRecnumeActionPerformed(evt);
            }
        });
        txtRecnume.addFocusListener(new java.awt.event.FocusAdapter() {
            public void focusGained(java.awt.event.FocusEvent evt) {
                txtRecnumeFocusGained(evt);
            }
            public void focusLost(java.awt.event.FocusEvent evt) {
                txtRecnumeFocusLost(evt);
            }
        });

        lblProdesc.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        lblProdesc.setForeground(new java.awt.Color(0, 51, 255));
        lblProdesc.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        lblProdesc.setText("  ");
        lblProdesc.setBorder(javax.swing.BorderFactory.createEtchedBorder());

        jLabel2.setFont(new java.awt.Font("Ubuntu", 0, 15)); // NOI18N
        jLabel2.setText("Fecha");

        jLabel3.setFont(new java.awt.Font("Ubuntu", 0, 15)); // NOI18N
        jLabel3.setText("Monto");

        txtFecha.setEditable(false);
        txtFecha.setForeground(new java.awt.Color(204, 0, 204));

        txtMonto.setEditable(false);
        txtMonto.setForeground(new java.awt.Color(204, 0, 204));
        txtMonto.setHorizontalAlignment(javax.swing.JTextField.RIGHT);

        lblMoneda.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        lblMoneda.setForeground(new java.awt.Color(0, 51, 255));
        lblMoneda.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        lblMoneda.setText("  ");
        lblMoneda.setBorder(javax.swing.BorderFactory.createEtchedBorder());

        jLabel4.setText("Recibo");

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGap(4, 4, 4)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(jLabel4)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(txtRecnume, javax.swing.GroupLayout.PREFERRED_SIZE, 89, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addComponent(lblProdesc, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(jLabel2)
                        .addGap(4, 4, 4)
                        .addComponent(txtFecha, javax.swing.GroupLayout.PREFERRED_SIZE, 103, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(layout.createSequentialGroup()
                                .addComponent(jLabel3)
                                .addGap(4, 4, 4)
                                .addComponent(txtMonto))
                            .addComponent(lblMoneda, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)))
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                        .addGap(0, 157, Short.MAX_VALUE)
                        .addComponent(btnAnular)
                        .addGap(4, 4, 4)
                        .addComponent(btnSalir)))
                .addContainerGap())
        );

        layout.linkSize(javax.swing.SwingConstants.HORIZONTAL, new java.awt.Component[] {btnAnular, btnSalir});

        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                .addGap(21, 21, 21)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(txtRecnume, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jLabel4))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(lblProdesc)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.CENTER)
                    .addComponent(jLabel2)
                    .addComponent(txtFecha, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jLabel3)
                    .addComponent(txtMonto, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(lblMoneda)
                .addGap(18, 47, Short.MAX_VALUE)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.CENTER)
                    .addComponent(btnSalir)
                    .addComponent(btnAnular))
                .addGap(4, 4, 4))
        );

        layout.linkSize(javax.swing.SwingConstants.VERTICAL, new java.awt.Component[] {btnAnular, btnSalir});

        setSize(new java.awt.Dimension(333, 254));
        setLocationRelativeTo(null);
    }// </editor-fold>//GEN-END:initComponents

    /** Closes the dialog */
    private void closeDialog(java.awt.event.WindowEvent evt) {//GEN-FIRST:event_closeDialog
        setVisible(false);
        dispose();
    }//GEN-LAST:event_closeDialog

    private void btnAnularActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnAnularActionPerformed
        this.btnAnularMouseClicked(null);
    }//GEN-LAST:event_btnAnularActionPerformed

    private void btnSalirActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnSalirActionPerformed
        dispose();
    }//GEN-LAST:event_btnSalirActionPerformed
/**
 * Búsqueda del recibo y despliegue del proveedor
 * @param evt
 */
    private void txtRecnumeFocusLost(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_txtRecnumeFocusLost
        recibo = txtRecnume.getText().trim();

        // Permito que el número sea cero o blanco para que el usuario
        // pueda usar otras opciones.
        if (recibo.equals("") || recibo.equals("0")){
            lblProdesc.setText("");
            txtFecha.setText("");
            txtMonto.setText("0.00");
            lblMoneda.setText("");
            return;
        } // end if
        
        // Consulto los datos del recibo.
        String sqlSelect =
                "Select " +                
                "    inproved.prodesc,            " +
                "    Dtoc(cxppage.fecha) as fecha," +
                "    cxppage.monto,               " +
                "    reccaja,                     " +
                "    monedas.descrip              " +
                "from cxppage                     " +
                "Inner join inproved on cxppage.procode = inproved.procode " +
                "Inner join monedas  on cxppage.codigoTC = monedas.codigo  " +
                "Where recnume = ? " +
                "and estado = '' and cerrado = 'N'";
        PreparedStatement ps;
        try {
            ps = conn.prepareStatement(sqlSelect, 
                    ResultSet.TYPE_SCROLL_SENSITIVE, ResultSet.CONCUR_READ_ONLY);
            ps.setInt(1, Integer.parseInt(recibo));
            
            rs = CMD.select(ps);
            
            if (Ut.goRecord(rs, Ut.FIRST)){
                lblProdesc.setText(rs.getString("prodesc"));
                txtFecha.setText(rs.getString("Fecha"));
                txtMonto.setText(
                            Ut.setDecimalFormat(
                            rs.getString("Monto"), "#,##0.00"));

                lblMoneda.setText(rs.getString("descrip"));
                this.reccaja = rs.getInt("reccaja");
            } else {
                lblProdesc.setText("");
                txtFecha.setText("");
                txtMonto.setText("0.00");
                lblMoneda.setText("");
                this.reccaja = 0;
                JOptionPane.showMessageDialog(null,
                        "Recibo no encontrado." +
                        "\nPodría darse alguna de la siguientes " +
                        "situaciones:\n" +
                        "1. El recibo ya se encuentra anulado.\n" +
                        "2. El recibo se encuentra en un período cerrado.\n" +
                        "3. El recibo no existe en la base de datos.",
                        "Error",
                        JOptionPane.ERROR_MESSAGE);
            } // end if
            
            ps.close();
        } catch (Exception ex) {
            Logger.getLogger(AnulacionRecibosCXP.class.getName()).log(Level.SEVERE, null, ex);
            JOptionPane.showMessageDialog(null, 
                    ex.getMessage(),
                    "Error",
                    JOptionPane.ERROR_MESSAGE);
            new Bitacora().writeToLog(this.getClass().getName() + "--> " + ex.getMessage());
        } // end try-catch
        
    }//GEN-LAST:event_txtRecnumeFocusLost

    private void txtRecnumeActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_txtRecnumeActionPerformed
        // Esto provoca que se ejecute el FocusLost en txtRecnume
        txtRecnume.transferFocus();
    }//GEN-LAST:event_txtRecnumeActionPerformed

    private void txtRecnumeFocusGained(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_txtRecnumeFocusGained
        txtRecnume.selectAll();
    }//GEN-LAST:event_txtRecnumeFocusGained

    private void btnAnularMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_btnAnularMouseClicked
        if (!validarAccion()) {
            return;
        } // end if

        Catransa tran;
        recibo = txtRecnume.getText().trim();

        // Confirmar la anulación
        int respuesta =
            JOptionPane.showConfirmDialog(null,
                    "¿Realmente desea anular este recibo?",
                    "Confirme..",
                    JOptionPane.YES_NO_OPTION);
        if (respuesta == JOptionPane.NO_OPTION){
            return;
        } // end if

        tran = new Catransa(conn);
        
        boolean hayTransaccion = false;
        PreparedStatement ps;
        String sqlDelete = "Call AnularPagoCXP(?)";
        
        try {
            hayTransaccion = CMD.transaction(conn, CMD.START_TRANSACTION);
            
            // Si existe referencia de caja procedo primero a anular el 
            // registro en caja. El segundo parametro le indica que no debe
            // hacer un un start transction.
            tran.anularRegistro(reccaja, false); // Si el reccaja va en cero no hace nada
            
            if (tran.isError()){
                CMD.transaction(conn, CMD.ROLLBACK);
                JOptionPane.showMessageDialog(null, 
                        tran.getMensaje_error(),
                        "Error",
                        JOptionPane.ERROR_MESSAGE);
                return;
            } // end if
            
            ps = conn.prepareStatement(sqlDelete, 
                    ResultSet.TYPE_SCROLL_SENSITIVE, ResultSet.CONCUR_READ_ONLY);
            
            ps.setInt(1, Integer.parseInt(recibo));
            
            // Utilizo executeQuery() porque el SP devuelve un RS
            // ya sea para indicar el error o para indicar que todo
            // salió bien.
            //rs = stat.executeQuery(sqlDelete);
            rs = CMD.select(ps);

            rs.first();

            if (rs.getBoolean(1)){
                JOptionPane.showMessageDialog(null,
                        rs.getString(2),
                        "Error", 
                        JOptionPane.ERROR_MESSAGE);
                CMD.transaction(conn, CMD.ROLLBACK);
                return;
            } // end if

            CMD.transaction(conn, CMD.COMMIT);
            JOptionPane.showMessageDialog(null,
                    "Recibo anulado satisfactoriamente.",
                    "Mensaje",
                    JOptionPane.INFORMATION_MESSAGE);

            lblProdesc.setText("");
            txtFecha.setText("");
            txtMonto.setText("0.00");

        } catch (SQLException ex) {
            JOptionPane.showMessageDialog(null, 
                    ex.getMessage(),
                    "Error", 
                    JOptionPane.ERROR_MESSAGE);
            lblProdesc.setText("");
            txtFecha.setText("");
            txtMonto.setText("0.00");
            new Bitacora().writeToLog(this.getClass().getName() + "--> " + ex.getMessage());

            if (hayTransaccion){
                try{
                    CMD.transaction(conn, CMD.ROLLBACK);
                } catch (SQLException ex1){
                    JOptionPane.showMessageDialog(null, 
                            ex1.getMessage(),
                            "Error", 
                            JOptionPane.ERROR_MESSAGE);
                    new Bitacora().writeToLog(this.getClass().getName() + "--> " + ex.getMessage());
                } // end try-catch
            } // end if
        } // end try-catch
    }//GEN-LAST:event_btnAnularMouseClicked

    

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnAnular;
    private javax.swing.JButton btnSalir;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel lblMoneda;
    private javax.swing.JLabel lblProdesc;
    private javax.swing.JTextField txtFecha;
    private javax.swing.JTextField txtMonto;
    private javax.swing.JFormattedTextField txtRecnume;
    // End of variables declaration//GEN-END:variables

    private boolean validarAccion(){
        boolean todoCorrecto = true;
        // Si la etiqueta que despliega el nombre del proveedor está
        // vacía significa que el recibo digitado no es válido.
        if (this.lblProdesc.getText().trim().equals("")){
            JOptionPane.showMessageDialog(null,
                    "Número de recibo no válido.",
                    "Error", 
                    JOptionPane.ERROR_MESSAGE);
            txtRecnume.requestFocusInWindow();
            return false;
        } // end if

        return todoCorrecto;
    } // end validarAccion
}
