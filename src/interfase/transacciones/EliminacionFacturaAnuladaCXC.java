/*
 * EliminacionReciboAnuladoCXC.java
 *
 * Created on 03/09/2011, 05:21:14 PM
 */

package interfase.transacciones;

import Mail.Bitacora;
import accesoDatos.CMD;
import accesoDatos.UtilBD;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.JOptionPane;

/**
 *
 * @author Bosco
 */
@SuppressWarnings("serial")
public class EliminacionFacturaAnuladaCXC extends javax.swing.JFrame {
    Connection conn;
    /** Creates new form EliminacionReciboAnuladoCXC
     * @param c */
    public EliminacionFacturaAnuladaCXC(Connection c) {
        initComponents();
        conn = c;
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jScrollPane1 = new javax.swing.JScrollPane();
        jTextPane1 = new javax.swing.JTextPane();
        jLabel1 = new javax.swing.JLabel();
        txtFacnume = new javax.swing.JFormattedTextField();
        txtClidesc = new javax.swing.JTextField();
        txtFacfech = new javax.swing.JTextField();
        cmdBorrar = new javax.swing.JButton();
        cmdSalir = new javax.swing.JButton();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setTitle("Eliminar facturas anuladas (CXC)");

        jTextPane1.setBorder(new javax.swing.border.SoftBevelBorder(javax.swing.border.BevelBorder.RAISED));
        jTextPane1.setEditable(false);
        jTextPane1.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jTextPane1.setForeground(new java.awt.Color(255, 0, 0));
        jTextPane1.setText("Esta opción elimina de la base de datos las facturas anuladas con el fin de que se puedan volver a ingresar.  Es responsabilidad del usuario darle uso apropiado a esta herramienta.");
        jScrollPane1.setViewportView(jTextPane1);

        jLabel1.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jLabel1.setText("Factura:");

        txtFacnume.setColumns(6);
        txtFacnume.setHorizontalAlignment(javax.swing.JTextField.RIGHT);
        txtFacnume.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                txtFacnumeActionPerformed(evt);
            }
        });
        txtFacnume.addFocusListener(new java.awt.event.FocusAdapter() {
            public void focusGained(java.awt.event.FocusEvent evt) {
                txtFacnumeFocusGained(evt);
            }
        });

        txtClidesc.setEditable(false);
        txtClidesc.setForeground(new java.awt.Color(51, 0, 255));

        txtFacfech.setEditable(false);
        txtFacfech.setForeground(new java.awt.Color(51, 0, 255));

        cmdBorrar.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        cmdBorrar.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Icons/eraser.png"))); // NOI18N
        cmdBorrar.setText("Borrar");
        cmdBorrar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cmdBorrarActionPerformed(evt);
            }
        });

        cmdSalir.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        cmdSalir.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Icons/control-power.png"))); // NOI18N
        cmdSalir.setText("Cerrar");
        cmdSalir.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cmdSalirActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addContainerGap()
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 343, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addGroup(layout.createSequentialGroup()
                                .addComponent(jLabel1)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                    .addComponent(txtClidesc, javax.swing.GroupLayout.PREFERRED_SIZE, 288, javax.swing.GroupLayout.PREFERRED_SIZE)
                                    .addComponent(txtFacnume, javax.swing.GroupLayout.PREFERRED_SIZE, 86, javax.swing.GroupLayout.PREFERRED_SIZE)
                                    .addComponent(txtFacfech, javax.swing.GroupLayout.PREFERRED_SIZE, 84, javax.swing.GroupLayout.PREFERRED_SIZE)))))
                    .addGroup(layout.createSequentialGroup()
                        .addGap(105, 105, 105)
                        .addComponent(cmdBorrar)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(cmdSalir)))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        layout.linkSize(javax.swing.SwingConstants.HORIZONTAL, new java.awt.Component[] {cmdBorrar, cmdSalir});

        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(18, 18, 18)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel1)
                    .addComponent(txtFacnume, javax.swing.GroupLayout.PREFERRED_SIZE, 22, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(4, 4, 4)
                .addComponent(txtClidesc, javax.swing.GroupLayout.PREFERRED_SIZE, 22, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(4, 4, 4)
                .addComponent(txtFacfech, javax.swing.GroupLayout.PREFERRED_SIZE, 22, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 33, Short.MAX_VALUE)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.CENTER)
                    .addComponent(cmdSalir, javax.swing.GroupLayout.PREFERRED_SIZE, 28, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(cmdBorrar))
                .addGap(5, 5, 5))
        );

        layout.linkSize(javax.swing.SwingConstants.VERTICAL, new java.awt.Component[] {cmdBorrar, cmdSalir});

        setSize(new java.awt.Dimension(371, 264));
        setLocationRelativeTo(null);
    }// </editor-fold>//GEN-END:initComponents

    private void txtFacnumeActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_txtFacnumeActionPerformed
        this.txtClidesc.setText("");
        this.txtFacfech.setText("");
        int recnume = 0;
        try {
            recnume = Integer.parseInt(txtFacnume.getText().trim());
        } catch(Exception ex){
            JOptionPane.showMessageDialog(null, 
                    ex.getMessage(),
                    "Error",
                    JOptionPane.ERROR_MESSAGE);
            new Bitacora().writeToLog(this.getClass().getName() + "--> " + ex.getMessage());
        } // end try-catch
        
        // Consulto el registro.  Esta factura tiene que estar nula ya que es
        // condición fundamental para la eliminación.
        String sqlSent =
            "Select " +
            "    dtoc(facfech) as fecha, clidesc " +
            "From faencabe, inclient " +
            "Where facnume = ? " +
            "and facnd = 0 " +
            "and facestado = 'A'  " +
            "and faencabe.clicode = inclient.clicode";

        PreparedStatement pr;
        ResultSet rs;

        try {
            pr = conn.prepareStatement(sqlSent);
            pr.setInt(1, recnume);
            rs = pr.executeQuery();
            if (rs == null || !rs.first()){
                JOptionPane.showMessageDialog(null,
                        "La factura no existe o no está nulo.",
                        "Error",
                        JOptionPane.ERROR_MESSAGE);
                return;
            } // end if
            this.txtClidesc.setText(rs.getString("clidesc"));
            this.txtFacfech.setText(rs.getString("fecha"));
            rs.close();
        } catch (SQLException ex) {
            JOptionPane.showMessageDialog(null,
                    ex.getMessage(),
                    "Error",
                    JOptionPane.ERROR_MESSAGE);
            new Bitacora().writeToLog(this.getClass().getName() + "--> " + ex.getMessage());
        }
}//GEN-LAST:event_txtFacnumeActionPerformed

    private void txtFacnumeFocusGained(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_txtFacnumeFocusGained
        txtFacnume.selectAll();
}//GEN-LAST:event_txtFacnumeFocusGained

    private void cmdSalirActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cmdSalirActionPerformed
        dispose();
}//GEN-LAST:event_cmdSalirActionPerformed

    private void cmdBorrarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cmdBorrarActionPerformed
        if (txtClidesc.getText().trim().isEmpty() ||
                txtFacnume.getText().trim().isEmpty()){
            JOptionPane.showMessageDialog(null,
                    "Debe digitar una factura válida.",
                    "Error",
                    JOptionPane.ERROR_MESSAGE);
            txtFacnume.requestFocusInWindow();
        } // end if

        int facnume = 0;
        try {
            facnume = Integer.parseInt(txtFacnume.getText().trim());
        } catch(Exception ex){
            JOptionPane.showMessageDialog(null,
                    ex.getMessage(),
                    "Error",
                    JOptionPane.ERROR_MESSAGE);
            new Bitacora().writeToLog(this.getClass().getName() + "--> " + ex.getMessage());
        } // end try-catch

        // Confirmar la acción del usuario.
        int resp =
            JOptionPane.showConfirmDialog(null,
                    "¿Realmente desea borrar esta factura?",
                    "Confirme por favor..",
                    JOptionPane.YES_NO_OPTION,
                    JOptionPane.WARNING_MESSAGE);
        if (resp != JOptionPane.YES_OPTION){
            return;
        } // end if

        // Al llegar aquí ya se tiene seguridad de que la factura seré eliminada.

        // Hay que eliminar primero el detalle para evitar que la
        // integridad referencial de la base de datos cancele el borrado.
        String sqlDelete =
                "Delete from fadetall where facnume = ? and facnd = 0";
        PreparedStatement pr;
        int registros;

        //if (!UtilBD.SQLTransaction(conn, UtilBD.START_TRANSACTION)){
        //    return;
        //}

        boolean hayTransaccion = false;

        try {
            CMD.transaction(conn, CMD.START_TRANSACTION);
            hayTransaccion = true;
            pr = conn.prepareStatement(sqlDelete);
            pr.setInt(1, facnume);
            registros = pr.executeUpdate();

            // Mínimo un registro debe haber sido borrado.
            if (registros == 0){
                JOptionPane.showMessageDialog(null,
                        "No se pudo eliminar el detalle de la factura.\n" +
                        "Comuníquese con su Administrador de Base de Datos.",
                        "Error",
                        JOptionPane.ERROR_MESSAGE);
            } // end if

            if (registros > 0){
                // Elimino el encabezado.
                sqlDelete = "Delete from faencabe where facnume = ? and facnd = 0";
                pr = conn.prepareStatement(sqlDelete);
                pr.setInt(1, facnume);
                registros = pr.executeUpdate();

                if (registros == 0){
                    JOptionPane.showMessageDialog(null,
                            "No se pudo eliminar el encabezado de la factura.\n" +
                            "Comuníquese con su Administrador de Base de Datos.",
                            "Error",
                            JOptionPane.ERROR_MESSAGE);
                } // end if
            } // end if
            
            // Bosco agregado 02/03/2013.
            // Elimino los registros en las tablas de inventarios
            if (registros > 0){
                // Elimino el detalle.
                sqlDelete = "Delete from inmovimd Where movdocu = ? and movtido = 8";
                pr = conn.prepareStatement(sqlDelete);
                pr.setString(1, facnume+"");
                registros = pr.executeUpdate();

                if (registros == 0){
                    JOptionPane.showMessageDialog(null,
                            "No se pudo eliminar el detalle en inventarios.\n" +
                            "Comuníquese con su Administrador de Base de Datos.",
                            "Error",
                            JOptionPane.ERROR_MESSAGE);
                } // end if
            } // end if
            
            if (registros > 0){
                // Elimino el encabezado.
                sqlDelete = "Delete from inmovime Where movdocu = ? and movtido = 8";
                pr = conn.prepareStatement(sqlDelete);
                pr.setString(1, facnume+"");
                registros = pr.executeUpdate();

                if (registros == 0){
                    JOptionPane.showMessageDialog(null,
                            "No se pudo eliminar el encabezado en inventarios.\n" +
                            "Comuníquese con su Administrador de Base de Datos.",
                            "Error",
                            JOptionPane.ERROR_MESSAGE);
                } // end if
            } // end if
            // Fin Bosco agregado 2/03/2013.

            if (registros > 0){
                // Confirmo la transacción
                //UtilBD.SQLTransaction(conn, UtilBD.COMMIT);
                CMD.transaction(conn, CMD.COMMIT);
                JOptionPane.showMessageDialog(null,
                        "Factura eliminada satisfactoriamente.",
                        "Mensaje",
                        JOptionPane.INFORMATION_MESSAGE);
                // Pongo ahora todos los campos en blanco para que se vea
                // que algo sucedió.
                this.txtFacnume.setText("");
                this.txtClidesc.setText("");
                this.txtFacfech.setText("");
            } else {
                // Descarto la transacción
                //UtilBD.SQLTransaction(conn, UtilBD.ROLLBACK);
                CMD.transaction(conn, CMD.ROLLBACK);
            } // end if-else

            hayTransaccion = false;
            
        } catch (SQLException ex) {
            JOptionPane.showMessageDialog(null,
                    ex.getMessage(),
                    "Error",
                    JOptionPane.ERROR_MESSAGE);
            new Bitacora().writeToLog(this.getClass().getName() + "--> " + ex.getMessage());
            if (hayTransaccion){
                //UtilBD.SQLTransaction(conn, UtilBD.ROLLBACK);
                try {
                    CMD.transaction(conn, CMD.ROLLBACK);
                } catch (SQLException ex1) {
                    JOptionPane.showMessageDialog(null,
                        ex1.getMessage(),
                        "Error",
                        JOptionPane.ERROR_MESSAGE);
                    new Bitacora().writeToLog(this.getClass().getName() + "--> " + ex.getMessage());
                }
            }
        } // end try-catch
    }//GEN-LAST:event_cmdBorrarActionPerformed

    /**
     * @param c
    */
    public static void main(final Connection c) {
        try {
            // Integración del segundo nivel de seguridad.
            if (!UtilBD.tienePermiso(c,"EliminacionFacturaAnuladaCXC")){
                JOptionPane.showMessageDialog(null,
                        "Usted no está autorizado para ejecutar este proceso",
                        "Error - Permisos",
                        JOptionPane.ERROR_MESSAGE);
                return;
            } // end if
        } catch (Exception ex) {
            Logger.getLogger(EliminacionFacturaAnuladaCXC.class.getName()).log(Level.SEVERE, null, ex);
            JOptionPane.showMessageDialog(null, 
                    ex.getMessage(),
                    "Error",
                    JOptionPane.ERROR_MESSAGE);
            return;
        }
        java.awt.EventQueue.invokeLater(new Runnable() {
            @Override
            public void run() {
                new EliminacionFacturaAnuladaCXC(c).setVisible(true);
            }
        });
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton cmdBorrar;
    private javax.swing.JButton cmdSalir;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JTextPane jTextPane1;
    private javax.swing.JTextField txtClidesc;
    private javax.swing.JTextField txtFacfech;
    private javax.swing.JFormattedTextField txtFacnume;
    // End of variables declaration//GEN-END:variables

}
