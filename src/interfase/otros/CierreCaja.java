package interfase.otros;

import Mail.Bitacora;
import accesoDatos.CMD;
import accesoDatos.UtilBD;
import java.awt.Cursor;
import java.awt.event.WindowAdapter;
import java.awt.event.WindowEvent;
import java.sql.Connection;
import java.sql.Date;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Timestamp;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.JOptionPane;
import logica.utilitarios.Ut;


/**
 *
 * @author bosco
 */
public class CierreCaja extends javax.swing.JFrame {
    private static final long serialVersionUID = 100L;
    public Connection conn; // Se comparte la conexión con DesgloceDinero.java
    private boolean inicio, fin;
    private final Bitacora b = new Bitacora();

    /**
     * Creates new form CierreCaja
     * @param c
     */
    public CierreCaja(Connection c) {
        inicio = true;
        fin = false;
        initComponents();
        // Defino el escuchador con una clase anónima para controlar la
        // salida de esta pantalla.  Esto funciona simpre que se haya
        // establecido el siguiente parámetro:
        // setDefaultCloseOperation(javax.swing.WindowConstants.DO_NOTHING_ON_CLOSE)
        // Esta pantalla lo hace en initComponents().
        addWindowListener(new WindowAdapter(){
            @Override
            public void windowClosing(WindowEvent e){
                btnSalirActionPerformed(null);
            } // end windowClosing
        } // end class
        ); // end Listener
        
        //conn = DataBaseConnection.getConnection(this.getClass().getName());
        conn = c;
        
        inicio = false;
        
        this.datFecha1.setDate(new java.util.Date());
        this.datFecha2.setDate(new java.util.Date());
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel1 = new javax.swing.JPanel();
        jLabel8 = new javax.swing.JLabel();
        jLabel9 = new javax.swing.JLabel();
        datFecha1 = new com.toedter.calendar.JDateChooser();
        datFecha2 = new com.toedter.calendar.JDateChooser();
        jLabel1 = new javax.swing.JLabel();
        txtnSaldoIn = new javax.swing.JFormattedTextField();
        jPanel3 = new javax.swing.JPanel();
        btnGuardar = new javax.swing.JButton();
        btnSalir = new javax.swing.JButton();
        jPanel2 = new javax.swing.JPanel();
        jLabel10 = new javax.swing.JLabel();
        jLabel2 = new javax.swing.JLabel();
        jLabel7 = new javax.swing.JLabel();
        jLabel3 = new javax.swing.JLabel();
        txtnVentasCr = new javax.swing.JFormattedTextField();
        txtnVentasCo = new javax.swing.JFormattedTextField();
        txtnDevoluc = new javax.swing.JFormattedTextField();
        txtnRecibosCXC = new javax.swing.JFormattedTextField();
        jPanel4 = new javax.swing.JPanel();
        jLabel12 = new javax.swing.JLabel();
        jLabel14 = new javax.swing.JLabel();
        jLabel15 = new javax.swing.JLabel();
        jLabel16 = new javax.swing.JLabel();
        txtnComprasCr = new javax.swing.JFormattedTextField();
        txtnComprasCo = new javax.swing.JFormattedTextField();
        txtnPagosProv = new javax.swing.JFormattedTextField();
        txtnNDcxp = new javax.swing.JFormattedTextField();
        jPanel5 = new javax.swing.JPanel();
        jLabel6 = new javax.swing.JLabel();
        txtnSaldoFin = new javax.swing.JFormattedTextField();
        lblSaldoFisico = new javax.swing.JLabel();
        txtnSaldoFis = new javax.swing.JFormattedTextField();
        jLabel13 = new javax.swing.JLabel();
        txtnDiferencia = new javax.swing.JFormattedTextField();

        setDefaultCloseOperation(javax.swing.WindowConstants.DO_NOTHING_ON_CLOSE);
        setTitle("Revisar saldo de caja");

        jLabel8.setFont(new java.awt.Font("Ubuntu", 1, 15)); // NOI18N
        jLabel8.setText("Del");

        jLabel9.setFont(new java.awt.Font("Ubuntu", 1, 15)); // NOI18N
        jLabel9.setText("al");

        datFecha1.addPropertyChangeListener(new java.beans.PropertyChangeListener() {
            public void propertyChange(java.beans.PropertyChangeEvent evt) {
                datFecha1PropertyChange(evt);
            }
        });

        datFecha2.addPropertyChangeListener(new java.beans.PropertyChangeListener() {
            public void propertyChange(java.beans.PropertyChangeEvent evt) {
                datFecha2PropertyChange(evt);
            }
        });

        jLabel1.setForeground(new java.awt.Color(0, 153, 0));
        jLabel1.setText("Saldo inicial");

        txtnSaldoIn.setFormatterFactory(new javax.swing.text.DefaultFormatterFactory(new javax.swing.text.NumberFormatter(new java.text.DecimalFormat("#,##0.00"))));
        txtnSaldoIn.setHorizontalAlignment(javax.swing.JTextField.RIGHT);
        txtnSaldoIn.setText("0.00");
        txtnSaldoIn.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                txtnSaldoInActionPerformed(evt);
            }
        });
        txtnSaldoIn.addFocusListener(new java.awt.event.FocusAdapter() {
            public void focusGained(java.awt.event.FocusEvent evt) {
                txtnSaldoInFocusGained(evt);
            }
        });

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addGap(35, 35, 35)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.CENTER)
                    .addComponent(datFecha1, javax.swing.GroupLayout.PREFERRED_SIZE, 145, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jLabel8))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.CENTER)
                    .addComponent(jLabel9)
                    .addComponent(datFecha2, javax.swing.GroupLayout.PREFERRED_SIZE, 145, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jLabel1)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(txtnSaldoIn, javax.swing.GroupLayout.PREFERRED_SIZE, 222, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(33, Short.MAX_VALUE))
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.CENTER)
                    .addComponent(jLabel8)
                    .addComponent(jLabel9))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                        .addComponent(datFecha1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addComponent(datFecha2, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(jLabel1)
                        .addComponent(txtnSaldoIn, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addGap(0, 3, Short.MAX_VALUE))
        );

        jPanel3.setBorder(null);
        jPanel3.setPreferredSize(new java.awt.Dimension(308, 149));

        btnGuardar.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        btnGuardar.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Icons/WZSAVE.png"))); // NOI18N
        btnGuardar.setToolTipText("Guardar");
        btnGuardar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnGuardarActionPerformed(evt);
            }
        });

        btnSalir.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        btnSalir.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Icons/WZCLOSE.png"))); // NOI18N
        btnSalir.setToolTipText("Cerrar");
        btnSalir.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnSalirActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout jPanel3Layout = new javax.swing.GroupLayout(jPanel3);
        jPanel3.setLayout(jPanel3Layout);
        jPanel3Layout.setHorizontalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel3Layout.createSequentialGroup()
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addComponent(btnGuardar, javax.swing.GroupLayout.PREFERRED_SIZE, 53, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(btnSalir)
                .addContainerGap())
        );

        jPanel3Layout.linkSize(javax.swing.SwingConstants.HORIZONTAL, new java.awt.Component[] {btnGuardar, btnSalir});

        jPanel3Layout.setVerticalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel3Layout.createSequentialGroup()
                .addGap(4, 4, 4)
                .addGroup(jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(btnSalir)
                    .addComponent(btnGuardar, javax.swing.GroupLayout.PREFERRED_SIZE, 40, javax.swing.GroupLayout.PREFERRED_SIZE)))
        );

        jPanel3Layout.linkSize(javax.swing.SwingConstants.VERTICAL, new java.awt.Component[] {btnGuardar, btnSalir});

        jPanel2.setBorder(javax.swing.BorderFactory.createTitledBorder("VENTAS"));

        jLabel10.setText("Crédito");

        jLabel2.setText("Contado");

        jLabel7.setText("N. Créd. S/C");

        jLabel3.setText("Recibos");

        txtnVentasCr.setEditable(false);
        txtnVentasCr.setForeground(java.awt.Color.magenta);
        txtnVentasCr.setFormatterFactory(new javax.swing.text.DefaultFormatterFactory(new javax.swing.text.NumberFormatter(new java.text.DecimalFormat("#,##0.00"))));
        txtnVentasCr.setHorizontalAlignment(javax.swing.JTextField.RIGHT);
        txtnVentasCr.setText("0.00");

        txtnVentasCo.setEditable(false);
        txtnVentasCo.setForeground(java.awt.Color.blue);
        txtnVentasCo.setFormatterFactory(new javax.swing.text.DefaultFormatterFactory(new javax.swing.text.NumberFormatter(new java.text.DecimalFormat("#,##0.00"))));
        txtnVentasCo.setHorizontalAlignment(javax.swing.JTextField.RIGHT);
        txtnVentasCo.setText("0.00");

        txtnDevoluc.setEditable(false);
        txtnDevoluc.setForeground(java.awt.Color.blue);
        txtnDevoluc.setFormatterFactory(new javax.swing.text.DefaultFormatterFactory(new javax.swing.text.NumberFormatter(new java.text.DecimalFormat("#,##0.00"))));
        txtnDevoluc.setHorizontalAlignment(javax.swing.JTextField.RIGHT);
        txtnDevoluc.setText("0.00");

        txtnRecibosCXC.setEditable(false);
        txtnRecibosCXC.setForeground(java.awt.Color.blue);
        txtnRecibosCXC.setFormatterFactory(new javax.swing.text.DefaultFormatterFactory(new javax.swing.text.NumberFormatter(new java.text.DecimalFormat("#,##0.00"))));
        txtnRecibosCXC.setHorizontalAlignment(javax.swing.JTextField.RIGHT);
        txtnRecibosCXC.setText("0.00");

        javax.swing.GroupLayout jPanel2Layout = new javax.swing.GroupLayout(jPanel2);
        jPanel2.setLayout(jPanel2Layout);
        jPanel2Layout.setHorizontalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jLabel10)
                    .addComponent(jLabel2)
                    .addComponent(jLabel3)
                    .addComponent(jLabel7))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(txtnRecibosCXC, javax.swing.GroupLayout.PREFERRED_SIZE, 222, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(txtnDevoluc, javax.swing.GroupLayout.PREFERRED_SIZE, 222, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(txtnVentasCo, javax.swing.GroupLayout.PREFERRED_SIZE, 222, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(txtnVentasCr, javax.swing.GroupLayout.PREFERRED_SIZE, 222, javax.swing.GroupLayout.PREFERRED_SIZE)))
        );
        jPanel2Layout.setVerticalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel10)
                    .addComponent(txtnVentasCr, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel2)
                    .addComponent(txtnVentasCo, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel7)
                    .addComponent(txtnDevoluc, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel3)
                    .addComponent(txtnRecibosCXC, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(0, 0, Short.MAX_VALUE))
        );

        jPanel4.setBorder(javax.swing.BorderFactory.createTitledBorder("COMPRAS"));

        jLabel12.setText("Crédito");

        jLabel14.setText("Contado");

        jLabel15.setText("N. Déb. S/C");

        jLabel16.setText("Pagos");

        txtnComprasCr.setEditable(false);
        txtnComprasCr.setForeground(java.awt.Color.magenta);
        txtnComprasCr.setFormatterFactory(new javax.swing.text.DefaultFormatterFactory(new javax.swing.text.NumberFormatter(new java.text.DecimalFormat("#,##0.00"))));
        txtnComprasCr.setHorizontalAlignment(javax.swing.JTextField.RIGHT);
        txtnComprasCr.setText("0.00");

        txtnComprasCo.setEditable(false);
        txtnComprasCo.setForeground(java.awt.Color.blue);
        txtnComprasCo.setFormatterFactory(new javax.swing.text.DefaultFormatterFactory(new javax.swing.text.NumberFormatter(new java.text.DecimalFormat("#,##0.00"))));
        txtnComprasCo.setHorizontalAlignment(javax.swing.JTextField.RIGHT);
        txtnComprasCo.setText("0.00");

        txtnPagosProv.setEditable(false);
        txtnPagosProv.setForeground(java.awt.Color.blue);
        txtnPagosProv.setFormatterFactory(new javax.swing.text.DefaultFormatterFactory(new javax.swing.text.NumberFormatter(new java.text.DecimalFormat("#,##0.00"))));
        txtnPagosProv.setHorizontalAlignment(javax.swing.JTextField.RIGHT);
        txtnPagosProv.setText("0.00");

        txtnNDcxp.setEditable(false);
        txtnNDcxp.setForeground(java.awt.Color.blue);
        txtnNDcxp.setFormatterFactory(new javax.swing.text.DefaultFormatterFactory(new javax.swing.text.NumberFormatter(new java.text.DecimalFormat("#,##0.00"))));
        txtnNDcxp.setHorizontalAlignment(javax.swing.JTextField.RIGHT);
        txtnNDcxp.setText("0.00");

        javax.swing.GroupLayout jPanel4Layout = new javax.swing.GroupLayout(jPanel4);
        jPanel4.setLayout(jPanel4Layout);
        jPanel4Layout.setHorizontalGroup(
            jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel4Layout.createSequentialGroup()
                .addGroup(jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jLabel12)
                    .addComponent(jLabel14)
                    .addComponent(jLabel16)
                    .addComponent(jLabel15))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addGroup(jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(txtnComprasCr, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.PREFERRED_SIZE, 222, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(txtnComprasCo, javax.swing.GroupLayout.PREFERRED_SIZE, 222, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(txtnPagosProv, javax.swing.GroupLayout.PREFERRED_SIZE, 222, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(txtnNDcxp, javax.swing.GroupLayout.PREFERRED_SIZE, 222, javax.swing.GroupLayout.PREFERRED_SIZE)))
        );
        jPanel4Layout.setVerticalGroup(
            jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel4Layout.createSequentialGroup()
                .addGroup(jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.CENTER)
                    .addComponent(jLabel12)
                    .addComponent(txtnComprasCr, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.CENTER)
                    .addComponent(jLabel14)
                    .addComponent(txtnComprasCo, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel15)
                    .addComponent(txtnNDcxp, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.CENTER)
                    .addComponent(jLabel16)
                    .addComponent(txtnPagosProv, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(0, 0, Short.MAX_VALUE))
        );

        jLabel6.setText("Saldo final");

        txtnSaldoFin.setEditable(false);
        txtnSaldoFin.setForeground(java.awt.Color.blue);
        txtnSaldoFin.setFormatterFactory(new javax.swing.text.DefaultFormatterFactory(new javax.swing.text.NumberFormatter(new java.text.DecimalFormat("#,##0.00"))));
        txtnSaldoFin.setHorizontalAlignment(javax.swing.JTextField.RIGHT);
        txtnSaldoFin.setText("0.00");

        lblSaldoFisico.setForeground(new java.awt.Color(0, 153, 0));
        lblSaldoFisico.setText("Saldo físico");
        lblSaldoFisico.setCursor(new java.awt.Cursor(java.awt.Cursor.HAND_CURSOR));
        lblSaldoFisico.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                lblSaldoFisicoMouseClicked(evt);
            }
            public void mouseExited(java.awt.event.MouseEvent evt) {
                lblSaldoFisicoMouseExited(evt);
            }
            public void mouseEntered(java.awt.event.MouseEvent evt) {
                lblSaldoFisicoMouseEntered(evt);
            }
        });

        txtnSaldoFis.setFormatterFactory(new javax.swing.text.DefaultFormatterFactory(new javax.swing.text.NumberFormatter(new java.text.DecimalFormat("#,##0.00"))));
        txtnSaldoFis.setHorizontalAlignment(javax.swing.JTextField.RIGHT);
        txtnSaldoFis.setText("0.00");
        txtnSaldoFis.setFont(new java.awt.Font("Ubuntu", 1, 18)); // NOI18N
        txtnSaldoFis.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                txtnSaldoFisActionPerformed(evt);
            }
        });
        txtnSaldoFis.addFocusListener(new java.awt.event.FocusAdapter() {
            public void focusGained(java.awt.event.FocusEvent evt) {
                txtnSaldoFisFocusGained(evt);
            }
        });

        jLabel13.setText("Diferencia");

        txtnDiferencia.setEditable(false);
        txtnDiferencia.setForeground(java.awt.Color.blue);
        txtnDiferencia.setFormatterFactory(new javax.swing.text.DefaultFormatterFactory(new javax.swing.text.NumberFormatter(new java.text.DecimalFormat("#,##0.00"))));
        txtnDiferencia.setHorizontalAlignment(javax.swing.JTextField.RIGHT);
        txtnDiferencia.setText("0.00");
        txtnDiferencia.setFont(new java.awt.Font("Ubuntu", 1, 18)); // NOI18N

        javax.swing.GroupLayout jPanel5Layout = new javax.swing.GroupLayout(jPanel5);
        jPanel5.setLayout(jPanel5Layout);
        jPanel5Layout.setHorizontalGroup(
            jPanel5Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel5Layout.createSequentialGroup()
                .addGap(0, 0, Short.MAX_VALUE)
                .addGroup(jPanel5Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                    .addComponent(txtnSaldoFis, javax.swing.GroupLayout.PREFERRED_SIZE, 222, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addGroup(jPanel5Layout.createSequentialGroup()
                        .addGroup(jPanel5Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(lblSaldoFisico)
                            .addComponent(jLabel6)
                            .addComponent(jLabel13))
                        .addGroup(jPanel5Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(jPanel5Layout.createSequentialGroup()
                                .addGap(102, 102, 102)
                                .addComponent(txtnSaldoFin, javax.swing.GroupLayout.PREFERRED_SIZE, 222, javax.swing.GroupLayout.PREFERRED_SIZE))
                            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel5Layout.createSequentialGroup()
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(txtnDiferencia, javax.swing.GroupLayout.PREFERRED_SIZE, 222, javax.swing.GroupLayout.PREFERRED_SIZE)))))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
        jPanel5Layout.setVerticalGroup(
            jPanel5Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel5Layout.createSequentialGroup()
                .addGroup(jPanel5Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel6)
                    .addComponent(txtnSaldoFin, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel5Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblSaldoFisico)
                    .addComponent(txtnSaldoFis, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel5Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel13)
                    .addComponent(txtnDiferencia, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(0, 0, Short.MAX_VALUE))
        );

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jPanel5, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(jPanel3, javax.swing.GroupLayout.DEFAULT_SIZE, 700, Short.MAX_VALUE)
                    .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(jPanel2, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jPanel4, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)))
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                .addGap(8, 8, 8)
                .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.CENTER)
                    .addComponent(jPanel2, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jPanel4, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(42, 42, 42)
                .addComponent(jPanel5, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 31, Short.MAX_VALUE)
                .addComponent(jPanel3, javax.swing.GroupLayout.PREFERRED_SIZE, 44, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(8, 8, 8))
        );

        layout.linkSize(javax.swing.SwingConstants.VERTICAL, new java.awt.Component[] {jPanel2, jPanel4});

        pack();
        setLocationRelativeTo(null);
    }// </editor-fold>//GEN-END:initComponents

    private void txtnSaldoInFocusGained(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_txtnSaldoInFocusGained
        txtnSaldoIn.selectAll();
    }//GEN-LAST:event_txtnSaldoInFocusGained

    private void txtnSaldoInActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_txtnSaldoInActionPerformed
        Timestamp fecha1, fecha2;
        fecha1 = new Timestamp(this.datFecha1.getDate().getTime());
        fecha2 = new Timestamp(this.datFecha2.getDate().getTime());
        
        String sqlSent = 
                "Select " +
                "	(Select IfNull(sum(facmont),0) from faencabe" +
                "           Where date(facfech) between date(?) and date(?) " +  // 1 y 2
                "           and facnume > 0 and facnd = 0" +
                "           and facplazo = 0 " +
                "           and facestado = '') as ventas," +
                "       (Select IfNull(sum(facmont),0) from faencabe " +
                "           Where date(facfech) between date(?) and date(?) " +    // 3 y 4
                "           and facnume < 0" +
                "           and facplazo = 0" +
                "           and facestado = '') as NC," +
                "	(Select IfNull(sum(monto),0) from pagos " +
                "           Where date(fecha) between date(?) and date(?)" +        // 5 y 6
                "           and estado = '') as recibosCXC," +
                "	(Select IfNull(sum(total_fac *-1),0) from cxpfacturas" +
                "           Where tipo = 'FAC'" +
                "           and vence_en = 0  " +
                "           and date(fecha_fac) between date(?) and date(?)) as compras," + // 7 y 8
                "	(Select IfNull(sum(total_fac *-1),0) from cxpfacturas" +
                "           Where tipo = 'FAC'" +
                "           and vence_en > 0  " +
                "           and date(fecha_fac) between date(?) and date(?)) as comprasCR," + // 9 y 10
                "	(Select IfNull(sum(facmont),0) from faencabe" +
                "           Where date(facfech) between date(?) and date(?) " +  // 11 y 12
                "           and facnume > 0 and facnd = 0" +
                "           and facplazo > 0 " +
                "           and facestado = '') as credito,  " +
                "	(Select IfNull(sum(monto *-1),0) from cxppage  " +
                "           Where date(fecha) between date(?) and date(?) " +       // 13 y 14
                "           and estado = '') as pagosCXP, " +
                "       (Select IfNull(sum(total_fac *-1),0) from cxpfacturas" +
                "           Where tipo = 'NDB'" +
                "           and vence_en = 0  " +
                "           and date(fecha_fac) between date(?) and date(?)) as NDB_sc"; // 15 y 16
                
        PreparedStatement ps;
        ResultSet rs;
        try {
            ps = conn.prepareStatement(sqlSent, 
                    ResultSet.TYPE_SCROLL_SENSITIVE, ResultSet.CONCUR_READ_ONLY);
            ps.setTimestamp(1, fecha1);
            ps.setTimestamp(2, fecha2);
            ps.setTimestamp(3, fecha1);
            ps.setTimestamp(4, fecha2);
            ps.setTimestamp(5, fecha1);
            ps.setTimestamp(6, fecha2);
            ps.setTimestamp(7, fecha1);
            ps.setTimestamp(8, fecha2);
            ps.setTimestamp(9, fecha1);
            ps.setTimestamp(10, fecha2);
            ps.setTimestamp(11, fecha1);
            ps.setTimestamp(12, fecha2);
            ps.setTimestamp(13, fecha1);
            ps.setTimestamp(14, fecha2);
            ps.setTimestamp(15, fecha1);
            ps.setTimestamp(16, fecha2);
            rs = CMD.select(ps);
            if (rs == null || !rs.first()){
                return;
            } // end if
            
            this.txtnVentasCo.setText(Ut.setDecimalFormat(rs.getString("ventas"), "#,##0.00"));
            this.txtnVentasCr.setText(Ut.setDecimalFormat(rs.getString("credito"), "#,##0.00"));
            this.txtnRecibosCXC.setText(Ut.setDecimalFormat(rs.getString("recibosCXC"), "#,##0.00"));
            this.txtnDevoluc.setText(Ut.setDecimalFormat(rs.getString("NC"), "#,##0.00"));
            this.txtnComprasCo.setText(Ut.setDecimalFormat(rs.getString("compras"), "#,##0.00"));
            this.txtnComprasCr.setText(Ut.setDecimalFormat(rs.getString("comprasCR"), "#,##0.00"));
            this.txtnPagosProv.setText(Ut.setDecimalFormat(rs.getString("pagosCXP"), "#,##0.00"));
            this.txtnNDcxp.setText(Ut.setDecimalFormat(rs.getString("NDB_sc"), "#,##0.00"));
            
            double saldoIn = 
                    Double.parseDouble(Ut.quitarFormato(this.txtnSaldoIn.getText().trim()));
            double saldoFi = saldoIn 
                    + rs.getDouble("ventas") 
                    + rs.getDouble("NC") 
                    + rs.getDouble("recibosCXC") 
                    + rs.getDouble("compras") 
                    + rs.getDouble("pagosCXP")
                    + rs.getDouble("NDB_sc");
            this.txtnSaldoFin.setText(Ut.setDecimalFormat(saldoFi + "", "#,##0.00"));
            ps.close();
            txtnSaldoIn.transferFocus();
        } catch (Exception ex) {
            Logger.getLogger(CierreCaja.class.getName()).log(Level.SEVERE, null, ex);
            JOptionPane.showMessageDialog(null, 
                    ex.getMessage(),
                    "Error",
                    JOptionPane.ERROR_MESSAGE);
            b.writeToLog(this.getClass().getName() + "--> " + ex.getMessage());
        } // end try-catch
    }//GEN-LAST:event_txtnSaldoInActionPerformed

    private void txtnSaldoFisActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_txtnSaldoFisActionPerformed
        double saldoFisico, saldoFin, dif;
        try {
            saldoFin = Double.parseDouble(Ut.quitarFormato(txtnSaldoFin.getText().trim()));
            saldoFisico = Double.parseDouble(Ut.quitarFormato(txtnSaldoFis.getText().trim()));
            dif = saldoFisico - saldoFin;
            txtnDiferencia.setText(Ut.setDecimalFormat(dif + "", "#,##0.00"));
        } catch (Exception ex) {
            Logger.getLogger(CierreCaja.class.getName()).log(Level.SEVERE, null, ex);
            JOptionPane.showMessageDialog(null, 
                    ex.getMessage(),
                    "Error",
                    JOptionPane.ERROR_MESSAGE);
            b.writeToLog(this.getClass().getName() + "--> " + ex.getMessage());
        } // end try-catch
        txtnDiferencia.transferFocus();
    }//GEN-LAST:event_txtnSaldoFisActionPerformed

    private void txtnSaldoFisFocusGained(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_txtnSaldoFisFocusGained
        txtnSaldoFis.selectAll();
    }//GEN-LAST:event_txtnSaldoFisFocusGained

    private void btnSalirActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnSalirActionPerformed
        this.fin = true;
        try {
            conn.close();
        } catch (SQLException ex) {
            Logger.getLogger(CierreCaja.class.getName()).log(Level.SEVERE, null, ex);
            b.writeToLog(this.getClass().getName() + "--> " + ex.getMessage());
        }
        dispose();
    }//GEN-LAST:event_btnSalirActionPerformed

    private void btnGuardarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnGuardarActionPerformed
        java.sql.Date dFecha1, dFecha2;
        double nSaldoIn,nVentasCr,nVentasCo,nDevoluc,nRecibosCXC,nComprasCr,
                nComprasCo,nNotasDsc, nPagosProv,nSaldoFin,nSaldoFis,nDiferencia;
        PreparedStatement ps;
        String sqlInsert, sqlDelete, sqlSent;
        
        dFecha1 = new java.sql.Date(this.datFecha1.getCalendar().getTimeInMillis());
        dFecha2 = new java.sql.Date(this.datFecha2.getCalendar().getTimeInMillis());
        /*
        El método revisarFecha si aprovecha el borrado en cascada cuando el usuario
        confirma que desea eliminar aquellas fechas que sean mayores a la fecha
        que se está guardando.
        */
        if (!revisarFechas(dFecha1)){
            JOptionPane.showMessageDialog(null, 
                    "El cierre no se pudo guardar.",
                    "Advertencia",
                    JOptionPane.WARNING_MESSAGE);
            return;
        } // end if
        
        sqlDelete = "Delete from casaldo Where dFecha1 = ? and dFecha2 = ?";
        
        /*
        Aunque la tabla tiene integridad referencias con borrado en cascada
        se deshabilita esa característica aquí para evitar que se borren los
        datos del desgloce de moneda.
        Esto se debe a que el sistema no hace updates, borra y después inserta.
        */
        sqlSent = "SET FOREIGN_KEY_CHECKS=0";
        
        sqlInsert = 
                "INSERT INTO casaldo(" +
                "dFecha1,       " +
                "dFecha2,       " +
                "nSaldoIn,      " +
                "nVentasCr,     " +
                "nVentasCo,     " +
                "nDevoluc,      " +
                "nRecibosCXC,   " +
                "nComprasCr,    " +
                "nComprasCo,    " +
                "nNotasDsc,     " +
                "nPagosProv,    " +
                "nSaldoFin,     " +
                "nSaldoFis,     " +
                "nDiferencia)   " +
                "VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";
        
        try {
            // No estoy haciendo uso de transacciones por ahora
            
            
            // Desactivo el chequeo de llaves foráneas para poder utilizar la 
            // técnica de borrado e insertado.
            ps = conn.prepareStatement(sqlSent);
            CMD.update(ps);
            ps.close();
            
            // No hago update, si el registro existe lo borro y listo.
            ps = conn.prepareStatement(sqlDelete);
            ps.setDate(1, dFecha1);
            ps.setDate(2, dFecha2);
            CMD.update(ps);
            ps.close();
            
            nSaldoIn     = Double.parseDouble(Ut.quitarFormato(txtnSaldoIn.getText().trim()));
            nVentasCr    = Double.parseDouble(Ut.quitarFormato(txtnVentasCr.getText().trim()));
            nVentasCo    = Double.parseDouble(Ut.quitarFormato(txtnVentasCo.getText().trim()));
            nDevoluc     = Double.parseDouble(Ut.quitarFormato(txtnDevoluc.getText().trim()));
            nRecibosCXC  = Double.parseDouble(Ut.quitarFormato(txtnRecibosCXC.getText().trim()));
            nComprasCr   = Double.parseDouble(Ut.quitarFormato(txtnComprasCr.getText().trim()));
            nComprasCo   = Double.parseDouble(Ut.quitarFormato(txtnComprasCo.getText().trim()));
            nNotasDsc    = Double.parseDouble(Ut.quitarFormato(this.txtnNDcxp.getText().trim()));
            nPagosProv   = Double.parseDouble(Ut.quitarFormato(txtnPagosProv.getText().trim()));
            nSaldoFin    = Double.parseDouble(Ut.quitarFormato(txtnSaldoFin.getText().trim()));
            nSaldoFis    = Double.parseDouble(Ut.quitarFormato(txtnSaldoFis.getText().trim()));
            nDiferencia  = Double.parseDouble(Ut.quitarFormato(txtnDiferencia.getText().trim()));
            
            ps = conn.prepareStatement(sqlInsert);
            ps.setDate(1, dFecha1);
            ps.setDate(2, dFecha2);
            ps.setDouble(3, nSaldoIn);
            ps.setDouble(4, nVentasCr);
            ps.setDouble(5, nVentasCo);
            ps.setDouble(6, nDevoluc);
            ps.setDouble(7, nRecibosCXC);
            ps.setDouble(8, nComprasCr);
            ps.setDouble(9, nComprasCo);
            ps.setDouble(10, nNotasDsc);
            ps.setDouble(11, nPagosProv);
            ps.setDouble(12, nSaldoFin);
            ps.setDouble(13, nSaldoFis);
            ps.setDouble(14, nDiferencia);
            
            CMD.update(ps);
            ps.close();
            
            // Vuelvo a activar el chequeo de llaves
            sqlSent = "SET FOREIGN_KEY_CHECKS=1";
            ps = conn.prepareStatement(sqlSent);
            CMD.update(ps);
            ps.close();
        } catch (Exception ex) {
            Logger.getLogger(CierreCaja.class.getName()).log(Level.SEVERE, null, ex);
            JOptionPane.showMessageDialog(null, 
                    ex.getMessage(),
                    "Error",
                    JOptionPane.ERROR_MESSAGE);
            b.writeToLog(this.getClass().getName() + "--> " + ex.getMessage());
            return;
        } // end try-catch
        
        JOptionPane.showMessageDialog(null, 
                "Registro guardado satisfactoriamente.",
                "Error",
                JOptionPane.INFORMATION_MESSAGE);
    }//GEN-LAST:event_btnGuardarActionPerformed

    private void datFecha2PropertyChange(java.beans.PropertyChangeEvent evt) {//GEN-FIRST:event_datFecha2PropertyChange
        if (inicio || fin){
            return;
        } // end if
        
        String sqlSent = "Select * from casaldo Where dFecha1 = ? and dFecha2 = ?";
        
        java.sql.Date dFecha1, dFecha2;
        
        PreparedStatement ps;
        
        ResultSet rs;
        
        dFecha1 = new java.sql.Date(this.datFecha1.getCalendar().getTimeInMillis());
        dFecha2 = new java.sql.Date(this.datFecha2.getCalendar().getTimeInMillis());
        try {
            ps = conn.prepareStatement(sqlSent, 
                    ResultSet.TYPE_SCROLL_SENSITIVE, ResultSet.CONCUR_READ_ONLY);
            ps.setDate(1, dFecha1);
            ps.setDate(2, dFecha2);
            rs = CMD.select(ps);
            
            if (rs == null || !rs.first()){
                ps.close();
                // Si no hubo datos para estas fechas entonces verifico
                // si se cargó el saldo del cierre anterior para ejecutar
                // el proceso y obtener los datos para este cierre de caja.
                double saldoInicial = 
                        Double.parseDouble(
                        Ut.quitarFormato(txtnSaldoIn.getText().trim()));
                // Si el campo de saldo inicial tiene algún valor mayor que cero
                // realizo todo el proceso para que el usuario no tenga que hacer nada.
                if (saldoInicial > 0){
                    txtnSaldoInActionPerformed(null);
                } // end if
                return;
            } // end if
            
            txtnSaldoIn.setText(Ut.setDecimalFormat(rs.getString("nSaldoIn"), "#,##0.00"));
            txtnVentasCr.setText(Ut.setDecimalFormat(rs.getString("nVentasCr"), "#,##0.00"));
            txtnVentasCo.setText(Ut.setDecimalFormat(rs.getString("nVentasCo"), "#,##0.00"));
            txtnDevoluc.setText(Ut.setDecimalFormat(rs.getString("nDevoluc"), "#,##0.00"));
            txtnRecibosCXC.setText(Ut.setDecimalFormat(rs.getString("nRecibosCXC"), "#,##0.00"));
            txtnComprasCr.setText(Ut.setDecimalFormat(rs.getString("nComprasCr"), "#,##0.00"));
            txtnComprasCo.setText(Ut.setDecimalFormat(rs.getString("nComprasCo"), "#,##0.00"));
            txtnPagosProv.setText(Ut.setDecimalFormat(rs.getString("nPagosProv"), "#,##0.00"));
            txtnSaldoFin.setText(Ut.setDecimalFormat(rs.getString("nSaldoFin"), "#,##0.00"));
            txtnSaldoFis.setText(Ut.setDecimalFormat(rs.getString("nSaldoFis"), "#,##0.00"));
            txtnDiferencia.setText(Ut.setDecimalFormat(rs.getString("nDiferencia"), "#,##0.00"));
            this.txtnNDcxp.setText(Ut.setDecimalFormat(rs.getString("nNotasDsc"), "#,##0.00"));
            
            ps.close();
        } catch (Exception ex) {
            Logger.getLogger(CierreCaja.class.getName()).log(Level.SEVERE, null, ex);
            JOptionPane.showMessageDialog(null, 
                    ex.getMessage(),
                    "Error",
                    JOptionPane.ERROR_MESSAGE);
            b.writeToLog(this.getClass().getName() + "--> " + ex.getMessage());
        } // end try-catch
        
        
        
    }//GEN-LAST:event_datFecha2PropertyChange

    private void lblSaldoFisicoMouseEntered(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_lblSaldoFisicoMouseEntered
        Cursor c = new Cursor(Cursor.HAND_CURSOR);
        lblSaldoFisico.setCursor(c);
    }//GEN-LAST:event_lblSaldoFisicoMouseEntered

    private void lblSaldoFisicoMouseExited(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_lblSaldoFisicoMouseExited
        lblSaldoFisico.setCursor(null);
    }//GEN-LAST:event_lblSaldoFisicoMouseExited

    private void lblSaldoFisicoMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_lblSaldoFisicoMouseClicked
        DesgloceDinero dd;
        Date dFecha1 = new java.sql.Date(this.datFecha1.getCalendar().getTimeInMillis());
        Date dFecha2 = new java.sql.Date(this.datFecha2.getCalendar().getTimeInMillis());
        dd = new DesgloceDinero(this);
        dd.setMontoAnterior(txtnSaldoFis);
        dd.setdFecha1(dFecha1);
        dd.setdFecha2(dFecha2);
        dd.loadRecord();
        dd.setVisible(true);
    }//GEN-LAST:event_lblSaldoFisicoMouseClicked

    public void calcularDiferencia(){
        txtnSaldoFisActionPerformed(null);
    } // end calcularDiferencia
    
    private void datFecha1PropertyChange(java.beans.PropertyChangeEvent evt) {//GEN-FIRST:event_datFecha1PropertyChange
        if (inicio || fin){
            return;
        } // end if
        
        // Localizo el cierre anterior para tomar el saldo final de caja
        // que será el saldo inicial para el cierre de caja actual.
        
        String sqlSent = 
                "Select nSaldoFis from casaldo " +
                "Where dfecha2 = (Select max(dfecha2) from casaldo where dfecha2 < ?)";
        
        java.sql.Date dFecha1;
        
        PreparedStatement ps;
        
        ResultSet rs;
        
        dFecha1 = new java.sql.Date(this.datFecha1.getCalendar().getTimeInMillis());
        
        try {
            ps = conn.prepareStatement(sqlSent, 
                    ResultSet.TYPE_SCROLL_SENSITIVE, ResultSet.CONCUR_READ_ONLY);
            ps.setDate(1, dFecha1);
            rs = CMD.select(ps);
            
            if (rs == null || !rs.first()){
                ps.close();
                return;
            } // end if
            
            txtnSaldoIn.setText(Ut.setDecimalFormat(rs.getString("nSaldoFis"), "#,##0.00"));
            
            ps.close();
        } catch (Exception ex) {
            Logger.getLogger(CierreCaja.class.getName()).log(Level.SEVERE, null, ex);
            JOptionPane.showMessageDialog(null, 
                    ex.getMessage(),
                    "Error",
                    JOptionPane.ERROR_MESSAGE);
            b.writeToLog(this.getClass().getName() + "--> " + ex.getMessage());
        } // end try-catch
    }//GEN-LAST:event_datFecha1PropertyChange

    /**
     * @param c
     */
    public static void main(final Connection c) {
        //Connection c = DataBaseConnection.getConnection("temp");
        try {
            if (!UtilBD.tienePermiso(c,"CierreCaja")){
                JOptionPane.showMessageDialog(null,
                        "Usted no está autorizado para ejecutar este proceso",
                        "Error - Permisos",
                        JOptionPane.ERROR_MESSAGE);
                return;
            } // end if
            //DataBaseConnection.setFreeConnection("temp");
        } catch (Exception ex) {
            Logger.getLogger(CierreCaja.class.getName()).log(Level.SEVERE, null, ex);
            JOptionPane.showMessageDialog(null, 
                    ex.getMessage(),
                    "Error",
                    JOptionPane.ERROR_MESSAGE);
            return;
        }
        /* Set the Nimbus look and feel */
        //<editor-fold defaultstate="collapsed" desc=" Look and feel setting code (optional) ">
        /* If Nimbus (introduced in Java SE 6) is not available, stay with the default look and feel.
         * For details see http://download.oracle.com/javase/tutorial/uiswing/lookandfeel/plaf.html 
         */
        try {
            for (javax.swing.UIManager.LookAndFeelInfo info : javax.swing.UIManager.getInstalledLookAndFeels()) {
                if ("Nimbus".equals(info.getName())) {
                    javax.swing.UIManager.setLookAndFeel(info.getClassName());
                    break;
                }
            }
        } catch (ClassNotFoundException | 
                InstantiationException | 
                IllegalAccessException | 
                javax.swing.UnsupportedLookAndFeelException ex) {
            java.util.logging.Logger.getLogger(CierreCaja.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        }
        //</editor-fold>

        /* Create and display the form */
        java.awt.EventQueue.invokeLater(new Runnable() {
            @Override
            public void run() {
                new CierreCaja(c).setVisible(true);
            }
        });
    }
    
    public void setNsaldoFis(String monto){
        this.txtnSaldoFis.setText(monto);
    } // end setNsaldoFis
    
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnGuardar;
    private javax.swing.JButton btnSalir;
    private com.toedter.calendar.JDateChooser datFecha1;
    private com.toedter.calendar.JDateChooser datFecha2;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel10;
    private javax.swing.JLabel jLabel12;
    private javax.swing.JLabel jLabel13;
    private javax.swing.JLabel jLabel14;
    private javax.swing.JLabel jLabel15;
    private javax.swing.JLabel jLabel16;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel6;
    private javax.swing.JLabel jLabel7;
    private javax.swing.JLabel jLabel8;
    private javax.swing.JLabel jLabel9;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JPanel jPanel4;
    private javax.swing.JPanel jPanel5;
    private javax.swing.JLabel lblSaldoFisico;
    private javax.swing.JFormattedTextField txtnComprasCo;
    private javax.swing.JFormattedTextField txtnComprasCr;
    private javax.swing.JFormattedTextField txtnDevoluc;
    private javax.swing.JFormattedTextField txtnDiferencia;
    private javax.swing.JFormattedTextField txtnNDcxp;
    private javax.swing.JFormattedTextField txtnPagosProv;
    private javax.swing.JFormattedTextField txtnRecibosCXC;
    private javax.swing.JFormattedTextField txtnSaldoFin;
    private javax.swing.JFormattedTextField txtnSaldoFis;
    private javax.swing.JFormattedTextField txtnSaldoIn;
    private javax.swing.JFormattedTextField txtnVentasCo;
    private javax.swing.JFormattedTextField txtnVentasCr;
    // End of variables declaration//GEN-END:variables

    /**
     * Revisa si existen fechas mayores a la que se va a guardar y de ser así
     * pide confirmación al usuario para eliminarlas ya que si no se eliminan
     * causarán problemas con el cálculo de sobrantes y faltantes de caja general.
     * @param dFecha1 
     */
    private boolean revisarFechas(Date dFecha1) {
        String sqlDelete = "Delete from casaldo Where dFecha1 > ?";
        String sqlSent   = "Select dtoc(dfecha1) as fecha from casaldo Where dFecha1 > ?";
        boolean huboError = false;
        
        PreparedStatement ps;
        ResultSet rs;
        
        try {
            ps = conn.prepareStatement(sqlSent,
                    ResultSet.TYPE_SCROLL_SENSITIVE, ResultSet.CONCUR_READ_ONLY);
            ps.setDate(1, dFecha1);
            rs = CMD.select(ps);
            
            int result = JOptionPane.NO_OPTION;
            
            if (rs != null && rs.first()){
                result = 
                    JOptionPane.showConfirmDialog(null, 
                            "Existe un cierre de caja con fecha " + rs.getString(1) + ".\n" +
                            "¿Desea eliminarlo antes de continuar?",
                            "Confirme por favor..",
                            JOptionPane.YES_NO_OPTION,
                            JOptionPane.WARNING_MESSAGE);
            } // end if
            
            ps.close();
            
            if (result == JOptionPane.YES_OPTION){
                ps = conn.prepareStatement(sqlDelete);
                ps.setDate(1, dFecha1);
                CMD.update(ps);
            } // end if
        } catch (SQLException ex) {
            Logger.getLogger(CierreCaja.class.getName()).log(Level.SEVERE, null, ex);
            huboError = true;
            JOptionPane.showMessageDialog(null, 
                    ex.getMessage(),
                    "Error",
                    JOptionPane.ERROR_MESSAGE);
            b.writeToLog(this.getClass().getName() + "--> " + ex.getMessage());
        } // end try-catch
        
        return !huboError;
    } // end revisarFechas
}
